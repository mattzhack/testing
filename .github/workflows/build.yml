name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Permite ejecuciÃ³n manual

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v3
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'
        
    - name: Instalar dependencias del sistema
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git \
          zip \
          unzip \
          openjdk-11-jdk \
          python3-pip \
          autoconf \
          libtool \
          pkg-config \
          zlib1g-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libtinfo5 \
          cmake \
          libffi-dev \
          libssl-dev \
          wget \
          curl \
          cython3
        
    - name: Instalar Buildozer
      run: |
        pip install --upgrade pip
        pip install buildozer cython==0.29.33
        
    - name: Crear archivo de configuraciÃ³n local
      run: |
        # Crear directorio .buildozer local
        mkdir -p ~/.buildozer/android/platform
        
        # Configurar variables de entorno
        echo "ANDROIDSDK=$HOME/.buildozer/android/platform/android-sdk" >> $GITHUB_ENV
        echo "ANDROIDNDK=$HOME/.buildozer/android/platform/android-ndk-r23b" >> $GITHUB_ENV
        echo "ANDROIDAPI=30" >> $GITHUB_ENV
        echo "ANDROIDMINAPI=21" >> $GITHUB_ENV
        
    - name: Compilar APK
      run: |
        # Limpiar builds anteriores
        buildozer android clean 2>/dev/null || true
        
        # Compilar en modo debug
        echo "ðŸš€ Iniciando compilaciÃ³n..."
        buildozer android debug
        
    - name: Subir APK como artefacto
      uses: actions/upload-artifact@v3
      with:
        name: mikrotik-repair-apk
        path: bin/*.apk
        retention-days: 7
        
    - name: Mostrar informaciÃ³n del APK
      run: |
        if [ -f "bin/mikrotikreboot-1.0-debug.apk" ]; then
          echo "âœ… Â¡APK COMPILADO CON Ã‰XITO!"
          echo "ðŸ“± Archivo: bin/mikrotikreboot-1.0-debug.apk"
          echo "ðŸ“ TamaÃ±o: $(du -h bin/mikrotikreboot-1.0-debug.apk | cut -f1)"
          echo ""
          echo "ðŸ“¥ Descarga:"
          echo "1. Ve a la pestaÃ±a 'Actions'"
          echo "2. Click en el Ãºltimo workflow"
          echo "3. Descarga 'mikrotik-repair-apk'"
        else
          echo "âŒ No se encontrÃ³ el APK"
          ls -la bin/ 2>/dev/null || echo "No existe directorio bin"
        fi
